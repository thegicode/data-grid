<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>엑셀 스타일 데이터 그리드</title>
        <style>
            table {
                border-collapse: collapse;
            }
            th,
            td {
                border: 1px solid #ddd;
                padding: 8px;
                min-width: 100px;
                position: relative;
            }
            th {
                background-color: #f2f2f2;
                cursor: move;
            }
            input {
                width: 100%;
                height: 100%;
                border: none;
                outline: none;
                background: transparent;
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                padding: 8px;
                box-sizing: border-box;
            }
            .selected {
                outline: 2px solid #007bff;
            }
            .popover {
                position: absolute;
                background-color: white;
                border: 1px solid #ddd;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                z-index: 1000;
                max-height: 150px;
                overflow-y: auto;
                width: 100%;
                box-sizing: content-box;
                font-size: 12px;
            }
            .popover-item {
                padding: 8px;
                cursor: pointer;
            }
            .popover-item:hover,
            .popover-item.selected {
                background-color: #007bff;
                color: white;
            }
            .drag-over {
                border-right: 4px solid #007bff;
            }
        </style>
    </head>
    <body>
        <table id="dataGrid">
            <thead>
                <tr>
                    <th></th>
                    <th draggable="true" data-col="0">A</th>
                    <th draggable="true" data-col="1">B</th>
                    <th draggable="true" data-col="2">C</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <script>
            const grid = document.getElementById("dataGrid");
            const tbody = grid.querySelector("tbody");
            const thead = grid.querySelector("thead");
            const ingredients = [
                "사과",
                "바나나",
                "당근",
                "다시마",
                "계란",
                "감자",
                "토마토",
                "양파",
                "호박",
                "오이",
            ];
            let selectedCell = null;
            let isComposing = false;
            let popoverIndex = -1;

            function createGrid(rows, cols) {
                for (let i = 0; i < rows; i++) {
                    const row = document.createElement("tr");
                    const rowHeader = document.createElement("th");
                    rowHeader.textContent = i + 1;
                    row.appendChild(rowHeader);

                    for (let j = 0; j < cols; j++) {
                        const cell = document.createElement("td");
                        const input = document.createElement("input");
                        input.type = "text";
                        input.dataset.row = i;
                        input.dataset.col = j;
                        input.value = `${i} ${j}`;
                        input.readOnly = true; // 기본적으로 비활성화
                        cell.appendChild(input);
                        row.appendChild(cell);
                    }
                    tbody.appendChild(row);
                }
            }

            function createPopover() {
                const popover = document.createElement("div");
                popover.id = "popover";
                popover.className = "popover";
                popover.style.display = "none";
                document.body.appendChild(popover);
            }

            function showPopover(input, matches) {
                const popover = document.getElementById("popover");
                if (matches.length === 0) {
                    popover.style.display = "none";
                    return;
                }

                popover.innerHTML = matches
                    .map((item) => `<div class="popover-item">${item}</div>`)
                    .join("");
                const rect = input.getBoundingClientRect();
                popover.style.top = `${rect.bottom + window.scrollY}px`;
                popover.style.left = `${rect.left + window.scrollX}px`;
                popover.style.width = `${rect.width}px`;
                popover.style.display = "block";

                const popoverItems = popover.querySelectorAll(".popover-item");
                popoverItems.forEach((item, index) => {
                    item.addEventListener("click", () => {
                        input.value = item.textContent;
                        hidePopover();
                        input.focus();
                    });
                });
                popoverIndex = -1;
            }

            function hidePopover() {
                const popover = document.getElementById("popover");
                popover.style.display = "none";
                popoverIndex = -1;
            }

            function highlightPopoverItem(index) {
                const popover = document.getElementById("popover");
                const items = popover.querySelectorAll(".popover-item");
                items.forEach((item, i) => {
                    item.classList.toggle("selected", i === index);
                });
            }

            function selectCell(cell, editMode = false) {
                if (selectedCell) {
                    selectedCell.classList.remove("selected");
                    selectedCell.querySelector("input").readOnly = true; // 선택 해제 시 비활성화
                    hidePopover(); // 선택 해제 시 팝오버 숨기기
                }
                selectedCell = cell;
                selectedCell.classList.add("selected");
                const input = selectedCell.querySelector("input");
                if (editMode) {
                    input.readOnly = false; // 편집 모드일 때 활성화
                    input.focus();
                } else {
                    input.readOnly = true;
                    input.blur();
                }
            }

            grid.addEventListener("click", (e) => {
                const cell = e.target.closest("td");
                if (cell) {
                    selectCell(cell);
                }
            });

            grid.addEventListener("dblclick", (e) => {
                const cell = e.target.closest("td");
                if (cell) {
                    selectCell(cell, true); // 더블 클릭 시 편집 모드로
                }
            });

            grid.addEventListener("input", (e) => {
                if (e.target.tagName === "INPUT") {
                    const { row, col } = e.target.dataset;
                    console.log(
                        `셀 (${row}, ${col}) 값 변경: ${e.target.value}`
                    );

                    // 입력한 텍스트와 일치하는 식자재 찾기
                    const matches = ingredients.filter((item) =>
                        item.includes(e.target.value)
                    );
                    showPopover(e.target, matches);
                }
            });

            grid.addEventListener("compositionstart", (e) => {
                isComposing = true;
            });

            grid.addEventListener("compositionend", (e) => {
                isComposing = false;
            });

            document.addEventListener("keydown", (e) => {
                if (!selectedCell) return;

                const input = selectedCell.querySelector("input");
                const currentRow = parseInt(input.dataset.row);
                const currentCol = parseInt(input.dataset.col);
                const isEditing = document.activeElement === input;
                const popover = document.getElementById("popover");
                const items = popover.querySelectorAll(".popover-item");

                if (
                    popover.style.display === "block" &&
                    (e.key === "ArrowDown" ||
                        e.key === "ArrowUp" ||
                        e.key === "Enter")
                ) {
                    e.preventDefault();
                    if (e.key === "ArrowDown") {
                        popoverIndex = (popoverIndex + 1) % items.length;
                    } else if (e.key === "ArrowUp") {
                        popoverIndex =
                            (popoverIndex - 1 + items.length) % items.length;
                    } else if (e.key === "Enter") {
                        if (popoverIndex >= 0) {
                            items[popoverIndex].click();
                        } else {
                            hidePopover();
                        }
                        return;
                    }
                    highlightPopoverItem(popoverIndex);
                    return;
                }

                if (isEditing && !isComposing) {
                    switch (e.key) {
                        case "Enter":
                            e.preventDefault();
                            hidePopover();
                            moveTo(currentRow + 1, currentCol);
                            break;
                        case "Tab":
                            e.preventDefault();
                            hidePopover();
                            moveTo(currentRow, currentCol + 1);
                            break;
                        case "Escape":
                            e.preventDefault();
                            input.blur();
                            hidePopover();
                            break;
                    }
                } else if (!isEditing) {
                    switch (e.key) {
                        case "ArrowUp":
                            e.preventDefault();
                            moveTo(currentRow - 1, currentCol);
                            break;
                        case "ArrowDown":
                            e.preventDefault();
                            moveTo(currentRow + 1, currentCol);
                            break;
                        case "ArrowLeft":
                            e.preventDefault();
                            moveTo(currentRow, currentCol - 1);
                            break;
                        case "ArrowRight":
                            e.preventDefault();
                            moveTo(currentRow, currentCol + 1);
                            break;
                        case "Enter":
                            e.preventDefault();
                            input.readOnly = false; // 엔터 키로 편집 모드 활성화
                            input.focus();
                            break;
                    }
                }
            });

            function moveTo(row, col) {
                const nextCell = tbody.querySelector(
                    `td:has(input[data-row="${row}"][data-col="${col}"])`
                );
                if (nextCell) {
                    selectCell(nextCell);
                }
            }

            createGrid(10, 3);
            createPopover();
            selectCell(tbody.querySelector("td")); // 초기 선택

            // Drag and drop columns
            let draggedColIndex = null;
            let targetColIndex = null;

            thead.addEventListener("dragstart", (e) => {
                if (e.target.tagName === "TH") {
                    draggedColIndex = e.target.dataset.col;
                    e.dataTransfer.effectAllowed = "move";
                }
            });

            thead.addEventListener("dragover", (e) => {
                e.preventDefault();
                const th = e.target.closest("th");
                if (th && th.dataset.col !== draggedColIndex) {
                    targetColIndex = th.dataset.col;
                    removeDragOverClasses();
                    th.classList.add("drag-over");
                }
            });

            thead.addEventListener("dragleave", (e) => {
                const th = e.target.closest("th");
                if (th && th.dataset.col === targetColIndex) {
                    th.classList.remove("drag-over");
                    targetColIndex = null;
                }
            });

            thead.addEventListener("drop", (e) => {
                e.preventDefault();
                const th = e.target.closest("th");
                if (th && draggedColIndex !== null && targetColIndex !== null) {
                    insertColumn(draggedColIndex, targetColIndex);
                    removeDragOverClasses();
                    draggedColIndex = null;
                    targetColIndex = null;
                }
            });

            function removeDragOverClasses() {
                thead.querySelectorAll("th").forEach((th) => {
                    th.classList.remove("drag-over");
                });
            }

            function insertColumn(fromCol, toCol) {
                const fromIndex = parseInt(fromCol);
                const toIndex = parseInt(toCol);

                // Swap header
                const headers = Array.from(thead.querySelectorAll("th"));
                const fromHeader = headers[fromIndex + 1];
                const toHeader = headers[toIndex + 1];

                if (fromIndex < toIndex) {
                    toHeader.after(fromHeader);
                } else {
                    toHeader.before(fromHeader);
                }

                // Swap cells
                tbody.querySelectorAll("tr").forEach((row) => {
                    const cells = Array.from(row.querySelectorAll("td"));
                    const fromCell = cells[fromIndex];
                    const toCell = cells[toIndex];

                    if (fromIndex < toIndex) {
                        toCell.after(fromCell);
                    } else {
                        toCell.before(fromCell);
                    }
                });

                // Update dataset.col
                updateColumnDataIndexes();
            }

            function updateColumnDataIndexes() {
                thead.querySelectorAll("th").forEach((th, index) => {
                    if (index > 0) {
                        // Skip row header
                        th.dataset.col = index - 1;
                    }
                });

                tbody.querySelectorAll("tr").forEach((row) => {
                    row.querySelectorAll("td").forEach((td, index) => {
                        td.querySelector("input").dataset.col = index;
                    });
                });
            }
        </script>
    </body>
</html>
